# ModernWiki

Минималистичная вики-система, использующая Git-репозиторий в качестве базы данных и Markdown в качестве языка форматирования.

Сущность вики — это контроль версий и открытое сотрудничество. Использование зрелой системы Git позволяет лучше управлять проблемами вандализма, а Markdown упрощает редактирование.

## Быстрый старт

## 1. Создание репозитория контента

Репозиторий контента — это хранилище страниц вики, открытое для любых изменений пользователями. Используйте репозиторий [ModernWikiTemplate](https://github.com/Heerozh/ModernWikiTemplate.git) в качестве шаблона. Репозиторий имеет формат проекта Hugo, вы можете свободно изменять стиль сайта внутри него.

### **GitHub:**

Просто форкните [ModernWikiTemplate](https://github.com/Heerozh/ModernWikiTemplate.git)
Также поддерживаются Gitee, GitLab.

### **(Рекомендуется) Приватный Git-репозиторий:**

Пропустите этот шаг сейчас, вернитесь к нему после запуска системы:

Перейдите по адресу <http://localhost/git>, нажмите "Install Gitea" (Установить немедленно), зарегистрируйте учетную запись администратора (Admin), нажмите ➕ в правом верхнем углу, выберите "migrate" (миграция внешнего репозитория),
клонируйте <https://github.com/Heerozh/ModernWikiTemplate.git>
и переименуйте его в Wiki.

> Внимание: права доступа к репозиторию должны быть открыты для Push всем, иначе потребуется проверка через PR. Если вы хотите разрешить Push только для каталога Content, а для конфигурации сайта и файлов стилей требовать PR, можно использовать Git submodules, реализовав это с помощью двух разных репозиториев.

## 2. Настройка переменных окружения

Скопируйте шаблон файла переменных окружения:

```bash
cp .env.example .env
```

Отредактируйте файл `.env`, укажите ваш Git-репозиторий:

```bash
GIT_REPO=https:/domain.com/your-username/your-wiki-content.git
GIT_BRANCH=master
DOMAIN=:80 # Для локального тестирования можно использовать только :80, иначе доступ будет невозможен
```

> [!NOTE]
> После каждого изменения `.env` необходимо пересобрать образ: `docker compose build`

## 3. Запуск системы

Сначала установите Docker Engine и плагин docker-compose, затем:

```bash
# Запуск сервисов (сторонний Git-хостинг)
docker compose up -d

# Запуск сервисов (локальный хостинг на Gitea)
docker compose --profile with-gitea up -d
```

## 4. Доступ к вики

- Основной сайт: <http://localhost>
- Конечная точка Webhook: <http://localhost/webhook>
- Локальный репозиторий Gitea (если включен): <http://localhost/git/>

## 5. Настройка автоматического обновления

На примере GitHub, настройте срабатывание Webhook при Push:

1. Перейдите в настройки вашего репозитория GitHub
2. Нажмите на опцию "Webhooks"
3. Нажмите "Add Webhook"
4. Заполните конфигурацию:
   - **Payload URL**: `http://your-domain.com/webhook`
   - **Content type**: `application/json`
   - **Secret**: Введите ваш случайный пароль
   - **Which events**: Выберите "Just the push event"

Когда содержимое вашего Git-репозитория обновляется, этот Webhook запускает пересборку сайта Hugo.

Также поддерживаются Gitea, Gitee (только режим пароля WebHook) и GitLab, настройка аналогична.

## Анализ архитектуры системы

ModernWiki состоит из нескольких объединенных Docker-контейнеров, выбранных для минимального потребления ресурсов, всего около 130 МБ оперативной памяти:

### 1. Контейнер обновления сайта (hugo-builder)

- Загружает публичный Git-репозиторий и генерирует статические страницы с помощью Hugo
- Выводит результат в общий каталог `site`
- Одноразовый контейнер, завершает работу после выполнения.

### 2. Контейнер статического сайта (static-site)

- Постоянно обслуживает статические файлы из каталога `site`

### 3. Контейнер контроллера Webhook (webhook)

- Постоянно принимает запросы Webhook при выполнении git push
- После получения через Docker API перезапускает hugo-builder

### 4. Сервер комментариев

- artalk

### 5. Опционально: Контейнер Gitea (gitea)

- Опциональный контейнер для самостоятельного веб-хостинга Git
- Данные Gitea хранятся в каталоге `data/gitea`, их необходимо резервировать

### 6. Входной прокси-контейнер (proxy)

- Прослушивает порт 80 как точку входа
- Правила маршрутизации:
  - `/` → Контейнер статического сайта
  - `/webhook` → Контейнер Webhook
  - Поддерживает импорт дополнительных конфигураций сайтов Caddyfile

## Разработка и отладка

### Обновление

Сначала обновите этот репозиторий, затем выполните пересборку Docker, все образы и программное обеспечение будут обновлены до последних версий.

```bash
git pull
docker compose build --pull
```

### Просмотр логов

```bash
# Просмотр логов всех сервисов
docker compose logs -f

# Просмотр логов конкретного сервиса
docker compose logs -f hugo-builder
docker compose logs -f static-site
docker compose logs -f webhook
docker compose logs -f proxy
```

### Ручная пересборка сайта

```bash
docker compose restart hugo-builder
```

## Промышленное развертывание

Эта вики-система выполняет сборку только при обновлении репозитория, в остальное время обслуживает статические файлы, что требует крайне низких ресурсов. Поэтому достаточно экземпляра с возможностью резкого увеличения производительности (burstable instance) (**цена -50%**).

### 1. Использование доменного имени

Измените `.env`, установите `DOMAIN=` на ваше доменное имя.

### 2. Поддержка HTTPS

Не требует настройки, система автоматически и периодически будет запрашивать бесплатные сертификаты Let's Encrypt или ZeroSSL для вашего домена. Убедитесь, что:

- DNS вашего домена указывает на ваш сервер
- Порт 80 и 443 открыты в брандмауэре

## Способ развертывания Serverless (TODO)

Это самый дешевый способ развертывания, требующий оплаты только за трафик и хранение, но он сложен в настройке, имеет меньше функций и не рекомендуется, предоставлен только для справки.

- Использование стороннего хостинга репозиториев
- Использование Function Compute (FC) для получения Webhook через HTTP-триггер, запуска контейнера hugo-builder и вывода результата в хранилище OSS
- Включение статического хостинга сайтов для OSS, настройка доменного имени
- Настройка еще одной функции FC, срабатывающей ежемесячно по расписанию для обновления и загрузки SSL-сертификатов в OSS

## Лицензия

MIT License
