# ModernWiki

نظام ويكي بسيط للغاية يستخدم مستودع Git كقاعدة بيانات ولغة Markdown كلغة تنسيق.

جوهر ويكي هو التحكم في الإصدار والتعاون مفتوح المصدر، واستخدام Git الناضج يمكنه إدارة مشاكل التخريب الضار بشكل أفضل، كما أن Markdown أسهل في التحرير.

## البدء السريع

## 1. إنشاء مستودع المحتوى

مستودع المحتوى هو مستودع صفحات الويكي، متاح للمستخدمين للتعديل بحرية. يرجى استخدام مستودع [ModernWikiTemplate](https://github.com/Heerozh/ModernWikiTemplate.git) كنموذج. المستودع بتنسيق مشروع Hugo، يمكنك تعديل تصميم الموقع فيه كما تشاء.

### **GitHub:**

قم بعمل Fork مباشرة لمستودع [ModernWikiTemplate](https://github.com/Heerozh/ModernWikiTemplate.git)
يدعم أيضًا Gitee و GitLab.

### **مستودع Git خاص (مُوصى به):**

تخطى هذا الآن، بعد تشغيل النظام، عد للإعداد:

اذهب إلى <http://localhost/git> ، انقر مباشرة على Install Gitea (التثبيت الفوري)، سجل حساب Admin، انقر على ➕ في الزاوية اليمنى العليا، اختر migrate (هجرة مستودع خارجي)،
انسخ <https://github.com/Heerozh/ModernWikiTemplate.git>
، وغير الاسم إلى Wiki.

> ملاحظة: يجب فتح صلاحية الدفع (Push) للجميع في المستودع، وإلا سيتطلب مراجعة عبر PR. إذا كنت تريد أن يكون الدفع ممكنًا فقط لمجلد Content، بينما يتطلب ملفات إعدادات الموقع والتصميم PR، يمكنك استخدام وحدات Git الفرعية (Git submodules)، واستخدام مستودعين مختلفين لإنجاز ذلك.

## 2. تكوين متغيرات البيئة

انسخ نموذج متغيرات البيئة:

```bash
cp .env.example .env
```

قم بتحرير ملف `.env`، وحدد مستودع Git الخاص بك:

```bash
GIT_REPO=https:/domain.com/your-username/your-wiki-content.git
GIT_BRANCH=master
DOMAIN=:80 # للاختبار المحلي، يجب استخدام :80 فقط، وإلا لن يكون الوصول ممكنًا
```

> [!NOTE]
> بعد كل تعديل لملف `.env`، يجب إعادة بناء الصورة: `docker compose build`

## 3. تشغيل النظام

قم أولاً بتثبيت Docker Engine و docker-compose-plugin، ثم:

```bash
# تشغيل الخدمة (استضافة Git خارجية)
docker compose up -d

# تشغيل الخدمة (استضافة Gitea محلية)
docker compose --profile with-gitea up -d
```

## 4. الوصول إلى الويكي

- الموقع الرئيسي: <http://localhost>
- نقطة نهاية Webhook: <http://localhost/webhook>
- مستودع Gitea المحلي (إذا تم تمكينه): <http://localhost/git/>

## 5. إعداد التحديث التلقائي

على سبيل المثال في GitHub، قم بإعداد Webhook ليتم تشغيله عند الدفع (Push):

1. ادخل إلى إعدادات مستودع GitHub الخاص بك
2. انقر على خيار "Webhooks"
3. انقر على "Add Webhook"
4. املأ التكوين:
   - **Payload URL**: `http://your-domain.com/webhook`
   - **Content type**: `application/json`
   - **Secret**: أدخل كلمة مرور عشوائية
   - **Which events**: اختر "Just the push event"

عند تحديث محتوى مستودع Git الخاص بك، سيؤدي هذا Webhook إلى تشغيل إعادة بناء الموقع بواسطة Hugo.

يدعم أيضًا Gitea و Gitee (وضع كلمة مرور WebHook فقط) و GitLab، التكوين مشابه.

## تحليل بنية النظام

يتكون ModernWiki من عدة حاويات Docker مجتمعة، تم اختيار نظام خفيف الوزن، يستهلك 130 ميجابايت فقط من الذاكرة:

### 1. حاوية تحديث الموقع (hugo-builder)

- تسحب مستودع Git العام وتستخدم Hugo لإنشاء صفحات ويب ثابتة
- تخرج إلى مجلد `site` المشترك
- حاوية لمرة واحدة، تخرج بعد التنفيذ.

### 2. حاوية الموقع الثابت (static-site)

- تخدم الملفات الثابتة في مجلد `site` بشكل مستمر

### 3. حاوية متحكم Webhook (webhook)

- تستقبل طلبات webhook عند دفع Git بشكل مستمر
- عند الاستلام، تقوم بإعادة تشغيل hugo-builder عبر Docker API

### 4. خادم التعليقات

- artalk

### 5. اختياري: حاوية Gitea (gitea)

- حاوية اختيارية، لاستضافة صفحات Git ذاتيًا
- يتم تخزين بيانات Gitea في مجلد `data/gitea`، ويجب عمل نسخة احتياطية لها

### 6. حاوية الوكيل العكسي للدخول (proxy)

- تستمع على المنفذ 80 كمدخل
- قواعد التوجيه:
  - `/` → حاوية الموقع الثابت
  - `/webhook` → حاوية Webhook
  - تدعم استيراد تكوينات مواقع Caddyfile إضافية

## التطوير والتصحيح

### الترقية

قم أولاً بتحديث هذا المستودع، ثم نفذ إعادة بناء docker، وسيتم ترقية جميع الصور والبرامج إلى أحدث إصدار.

```bash
git pull
docker compose build --pull
```

### عرض السجلات

```bash
# عرض سجلات جميع الخدمات
docker compose logs -f

# عرض سجلات خدمة محددة
docker compose logs -f hugo-builder
docker compose logs -f static-site
docker compose logs -f webhook
docker compose logs -f proxy
```

### إعادة بناء الموقع يدويًا

```bash
docker compose restart hugo-builder
```

## النشر للإنتاج

يقوم نظام الويكي هذا بالبناء فقط عند تحديث المستودع، وعادة ما يخدم الملفات الثابتة، مما يجعله منخفض استهلاك الأداء للغاية. لذلك فإن مثيل الأداء المفاجئ يكفي (**سعر -50%**).

### 1. استخدام اسم نطاق

قم بتعديل `.evn`، واضبط `DOMAIN=` على اسم النطاق الخاص بك.

### 2. دعم HTTPS

لا حاجة للتكوين، سيقوم النظام تلقائيًا وبشكل دوري بطلب شهادات مجانية Let's Encrypt أو ZeroSSL لاسم النطاق الخاص بك. تأكد من:

- أن DNS اسم النطاق يشير إلى خادمك
- أن منافذ الجدار الناري 80 و 443 مفتوحة للخارج

## طريقة النشر بدون خادم (TODO)

هذه طريقة النشر الأقل سعرًا، حيث تحتاج فقط لشراء النطاق الترددي والتخزين، لكن نشرها معقد، ووظائفها قليلة، غير موصى بها، للإشارة فقط.

- استخدام مستودع استضافة خارجي
- الاستفادة من الحوسبة الوظيفية (FC)، واستقبال Webhook عبر مشغل Http، وتشغيل حاوية hugo-builder، وإخراجها إلى تخزين OSS
- تمكين استضافة الموقع الثابت لـ OSS، وتعيين اسم النطاق
- إعداد حوسبة وظيفية (FC) أخرى، يتم تشغيلها شهريًا على فترات، لتحديث وتحميل شهادات SSL إلى OSS

## الترخيص

رخصة MIT
